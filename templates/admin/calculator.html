{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-alu-900">3-Track Window Calculator</h1>
            <p class="text-alu-500">Window General Series - 1.5mm Thickness</p>
        </div>
        <div class="flex gap-3">
            <button onclick="openRatesModal()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-all">
                <i class="fa-solid fa-gear"></i> Edit Rates
            </button>
            <a href="{{ url_for('admin_dashboard') }}" class="text-blue-600 hover:underline flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Input Section -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
            <h2 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                <i class="fa-solid fa-ruler-combined text-blue-600"></i> Dimensions & Type
            </h2>

            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Width (Feet)</label>
                        <input type="number" id="calc_width" step="0.1" value="1" min="0.1"
                            class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 outline-none text-xl font-bold text-center">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Height (Feet)</label>
                        <input type="number" id="calc_height" step="0.1" value="1" min="0.1"
                            class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 outline-none text-xl font-bold text-center">
                    </div>
                </div>

                <!-- Finish Type Toggle -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Finish Type</label>
                    <div class="flex bg-gray-100 rounded-xl p-1">
                        <button type="button" id="btn_color" onclick="setFinish('color')"
                            class="flex-1 py-3 rounded-lg font-bold text-sm transition-all bg-alu-800 text-white shadow-md">
                            <span
                                class="inline-block w-4 h-4 rounded-full bg-alu-900 mr-2 align-middle border-2 border-white"></span>
                            Color ₹{{ rates.alu_color|default(410) }}/kg
                        </button>
                        <button type="button" id="btn_silver" onclick="setFinish('silver')"
                            class="flex-1 py-3 rounded-lg font-bold text-sm transition-all text-gray-600">
                            <span class="inline-block w-4 h-4 rounded-full bg-gray-300 mr-2 align-middle"></span>
                            Silver ₹{{ rates.alu_silver|default(360) }}/kg
                        </button>
                    </div>
                    <input type="hidden" id="finish_type" value="color">
                </div>

                <!-- Calculate Button -->
                <button onclick="updateCalculation()"
                    class="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-calculator"></i> Calculate Price
                </button>
            </div>
        </div>

        <!-- Materials Selection with Checkboxes -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-list-check text-green-600"></i> Select Materials
            </h2>

            <div class="space-y-2">
                <!-- Aluminum (Always included) -->
                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="chk_aluminum" checked disabled class="w-5 h-5 accent-blue-600">
                        <span class="font-medium text-gray-800">Aluminum Profile</span>
                    </label>
                    <span class="font-bold text-blue-700" id="cost_aluminum">₹1148</span>
                </div>

                <!-- Glass -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_glass" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Glass</span>
                            <span class="text-xs text-gray-500 block" id="lbl_glass">1 sqft × ₹45</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_glass">₹45</span>
                </div>

                <!-- Glass Rubber -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_rubber" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Glass Rubber</span>
                            <span class="text-xs text-gray-500 block" id="lbl_rubber">6 ft × ₹10</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_rubber">₹60</span>
                </div>

                <!-- Track Rubber -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_track_rubber" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Track Rubber</span>
                            <span class="text-xs text-gray-500 block">Per window</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_track_rubber">₹80</span>
                </div>

                <!-- Mosquito Net -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_net" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Mosquito Net</span>
                            <span class="text-xs text-gray-500 block" id="lbl_net">0.5 sqft × ₹10</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_net">₹5</span>
                </div>

                <!-- U-Channel -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_u_channel" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">U-Channel</span>
                            <span class="text-xs text-gray-500 block">Per window</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_u_channel">₹100</span>
                </div>

                <!-- Lock -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_lock" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Lock</span>
                            <span class="text-xs text-gray-500 block">Per window</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_lock">₹170</span>
                </div>

                <!-- Bearing -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_bearing" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Bearing</span>
                            <span class="text-xs text-gray-500 block">6 pcs × ₹10</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_bearing">₹60</span>
                </div>

                <!-- Screw -->
                <div
                    class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_screw" checked class="w-5 h-5 accent-green-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Screw</span>
                            <span class="text-xs text-gray-500 block">Per window</span>
                        </div>
                    </label>
                    <span class="font-bold text-gray-700" id="cost_screw">₹80</span>
                </div>

                <!-- Labour -->
                <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" id="chk_labour" checked class="w-5 h-5 accent-orange-600"
                            onchange="updateCalculation()">
                        <div>
                            <span class="font-medium text-gray-800">Labour Charge</span>
                            <span class="text-xs text-gray-500 block" id="lbl_labour">Min ₹350 or ₹24/sqft</span>
                        </div>
                    </label>
                    <span class="font-bold text-orange-600" id="cost_labour">₹350</span>
                </div>
            </div>
        </div>

        <!-- Total Section -->
        <div
            class="bg-gradient-to-br from-alu-900 to-alu-800 text-white p-6 rounded-2xl shadow-xl flex flex-col justify-between">
            <div>
                <h3 class="text-alu-400 uppercase text-xs font-bold tracking-widest mb-1">Estimated Total Price</h3>
                <div class="text-5xl font-bold mb-2" id="res_total">₹2,018</div>
                <p class="text-alu-400 text-sm mb-6">For <span id="res_dim">1×1</span> ft window (<span
                        id="res_finish">Color</span>)</p>

                <div class="space-y-3 bg-white/10 p-4 rounded-xl backdrop-blur">
                    <div class="flex justify-between text-sm">
                        <span class="text-alu-300">Window Area</span>
                        <span class="font-bold"><span id="res_area">1</span> sq.ft</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-alu-300">Aluminum Weight</span>
                        <span class="font-bold"><span id="res_weight">2.80</span> kg</span>
                    </div>
                    <div class="flex justify-between text-sm border-t border-white/20 pt-2">
                        <span class="text-alu-300">Aluminum</span>
                        <span class="font-bold">₹<span id="sum_aluminum">1148</span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-alu-300">Materials</span>
                        <span class="font-bold">₹<span id="sum_materials">520</span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-alu-300">Labour</span>
                        <span class="font-bold">₹<span id="sum_labour">350</span></span>
                    </div>
                </div>
            </div>

            <div class="space-y-3 mt-6">
                <button onclick="window.print()"
                    class="w-full bg-white/10 hover:bg-white/20 border border-white/20 py-3 rounded-xl transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-print"></i> Print Quote
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Rates Modal -->
<div id="ratesModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white">
            <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-gear text-blue-600 mr-2"></i>Edit Material
                Rates</h3>
            <button onclick="closeRatesModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <form action="{{ url_for('update_rates') }}" method="POST" class="p-6 space-y-4">
            <input type="hidden" name="redirect_to" value="calculator">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Aluminum Color (₹/kg)</label>
                    <input type="number" name="alu_color" value="{{ rates.alu_color|default(410) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Aluminum Silver (₹/kg)</label>
                    <input type="number" name="alu_silver" value="{{ rates.alu_silver|default(360) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Glass (₹/sqft)</label>
                    <input type="number" name="glass" value="{{ rates.glass|default(45) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Glass Rubber (₹/ft)</label>
                    <input type="number" name="glass_rubber" value="{{ rates.glass_rubber|default(10) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Track Rubber (₹/window)</label>
                    <input type="number" name="track_rubber" value="{{ rates.track_rubber|default(80) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Mosquito Net (₹/sqft)</label>
                    <input type="number" name="mosquito_net" value="{{ rates.mosquito_net|default(10) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">U-Channel (₹/window)</label>
                    <input type="number" name="u_channel" value="{{ rates.u_channel|default(100) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Lock (₹/unit)</label>
                    <input type="number" name="lock" value="{{ rates.lock|default(170) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Bearing (₹/unit)</label>
                    <input type="number" name="bearing" value="{{ rates.bearing|default(10) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Screw (₹/window)</label>
                    <input type="number" name="screw" value="{{ rates.screw|default(80) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Labour Min (₹)</label>
                    <input type="number" name="labour_min" value="{{ rates.labour_min|default(350) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Labour (₹/sqft)</label>
                    <input type="number" name="labour_sqft" value="{{ rates.labour_sqft|default(24) }}" step="1"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            <button type="submit"
                class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all">
                <i class="fa-solid fa-save mr-2"></i>Save Rates
            </button>
        </form>
    </div>
</div>

<script>
    // Rates from database
    const RATES = {
        alu_color: {{ rates.alu_color|default (410) }},
    alu_silver: { { rates.alu_silver |default (360) } },
    glass: { { rates.glass |default (45) } },
    glass_rubber: { { rates.glass_rubber |default (10) } },
    track_rubber: { { rates.track_rubber |default (80) } },
    mosquito_net: { { rates.mosquito_net |default (10) } },
    u_channel: { { rates.u_channel |default (100) } },
    screw: { { rates.screw |default (80) } },
    lock: { { rates.lock |default (170) } },
    bearing: { { rates.bearing |default (10) } },
    labour_min: { { rates.labour_min |default (350) } },
    labour_sqft: { { rates.labour_sqft |default (24) } }
    };

    let currentFinish = 'color';

    function setFinish(finish) {
        currentFinish = finish;
        document.getElementById('finish_type').value = finish;

        // Update button styles
        const btnColor = document.getElementById('btn_color');
        const btnSilver = document.getElementById('btn_silver');

        if (finish === 'color') {
            btnColor.className = 'flex-1 py-3 rounded-lg font-bold text-sm transition-all bg-alu-800 text-white shadow-md';
            btnSilver.className = 'flex-1 py-3 rounded-lg font-bold text-sm transition-all text-gray-600 hover:bg-gray-200';
        } else {
            btnColor.className = 'flex-1 py-3 rounded-lg font-bold text-sm transition-all text-gray-600 hover:bg-gray-200';
            btnSilver.className = 'flex-1 py-3 rounded-lg font-bold text-sm transition-all bg-gray-400 text-white shadow-md';
        }

        updateCalculation();
    }

    function openRatesModal() {
        document.getElementById('ratesModal').classList.remove('hidden');
        document.getElementById('ratesModal').classList.add('flex');
    }

    function closeRatesModal() {
        document.getElementById('ratesModal').classList.add('hidden');
        document.getElementById('ratesModal').classList.remove('flex');
    }

    function updateCalculation() {
        const w = parseFloat(document.getElementById('calc_width').value) || 1;
        const h = parseFloat(document.getElementById('calc_height').value) || 1;
        const finish = currentFinish;

        const area = w * h;

        // Weight calculation (based on 1x1 = 2.8kg baseline)
        // Using the formula: weight = (1.123 * w) + (1.677 * h)
        const totalWeight = (1.123 * w) + (1.677 * h);

        // Aluminum cost
        const aluRate = finish === 'color' ? RATES.alu_color : RATES.alu_silver;
        const aluCost = Math.round(totalWeight * aluRate);

        // Individual costs
        const glassCost = Math.round(area * RATES.glass);
        const rubberFt = (2 * w) + (4 * h);
        const rubberCost = Math.round(rubberFt * RATES.glass_rubber);
        const trackRubberCost = RATES.track_rubber;
        const netSqft = area * 0.5;
        const netCost = Math.round(netSqft * RATES.mosquito_net);
        const uChannelCost = RATES.u_channel;
        const lockCost = RATES.lock;
        const bearingCost = 6 * RATES.bearing;
        const screwCost = RATES.screw;
        const labourCost = Math.max(RATES.labour_min, Math.round(area * RATES.labour_sqft));

        // Update individual cost displays
        document.getElementById('cost_aluminum').innerText = '₹' + aluCost;
        document.getElementById('cost_glass').innerText = '₹' + glassCost;
        document.getElementById('cost_rubber').innerText = '₹' + rubberCost;
        document.getElementById('cost_track_rubber').innerText = '₹' + trackRubberCost;
        document.getElementById('cost_net').innerText = '₹' + netCost;
        document.getElementById('cost_u_channel').innerText = '₹' + uChannelCost;
        document.getElementById('cost_lock').innerText = '₹' + lockCost;
        document.getElementById('cost_bearing').innerText = '₹' + bearingCost;
        document.getElementById('cost_screw').innerText = '₹' + screwCost;
        document.getElementById('cost_labour').innerText = '₹' + labourCost;

        // Update labels
        document.getElementById('lbl_glass').innerText = area.toFixed(1) + ' sqft × ₹' + RATES.glass;
        document.getElementById('lbl_rubber').innerText = rubberFt.toFixed(0) + ' ft × ₹' + RATES.glass_rubber;
        document.getElementById('lbl_net').innerText = netSqft.toFixed(1) + ' sqft × ₹' + RATES.mosquito_net;
        document.getElementById('lbl_labour').innerText = 'Min ₹' + RATES.labour_min + ' or ₹' + RATES.labour_sqft + '/sqft';

        // Calculate total based on checked items
        let materialsTotal = 0;
        if (document.getElementById('chk_glass').checked) materialsTotal += glassCost;
        if (document.getElementById('chk_rubber').checked) materialsTotal += rubberCost;
        if (document.getElementById('chk_track_rubber').checked) materialsTotal += trackRubberCost;
        if (document.getElementById('chk_net').checked) materialsTotal += netCost;
        if (document.getElementById('chk_u_channel').checked) materialsTotal += uChannelCost;
        if (document.getElementById('chk_lock').checked) materialsTotal += lockCost;
        if (document.getElementById('chk_bearing').checked) materialsTotal += bearingCost;
        if (document.getElementById('chk_screw').checked) materialsTotal += screwCost;

        const labourTotal = document.getElementById('chk_labour').checked ? labourCost : 0;

        const grandTotal = aluCost + materialsTotal + labourTotal;

        // Update summary
        document.getElementById('res_dim').innerText = w + '×' + h;
        document.getElementById('res_finish').innerText = finish === 'color' ? 'Color' : 'Silver';
        document.getElementById('res_area').innerText = area.toFixed(1);
        document.getElementById('res_weight').innerText = totalWeight.toFixed(2);
        document.getElementById('sum_aluminum').innerText = aluCost;
        document.getElementById('sum_materials').innerText = materialsTotal;
        document.getElementById('sum_labour').innerText = labourTotal;
        document.getElementById('res_total').innerText = '₹' + grandTotal.toLocaleString('en-IN');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateCalculation();
    });
</script>

<style>
    @media print {

        header,
        button,
        #ratesModal {
            display: none !important;
        }

        .bg-gradient-to-br {
            background: #1a1a2e !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>
{% endblock %}